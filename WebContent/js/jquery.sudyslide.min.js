;(function ($) {
    $.fn.sudyslide =  function (opts) {
        var defaults = {
            p:null,
            json: [],
            title: {
                active: true, // 是否显示标题
                isAutoWidth: false, // 标题背景自动宽度
                href: false // 标题是否加文章链接
            },
            text: {
                active: false, // 是否显示文章简介
                isAutoHeight: false, // 简介背景自动高度
                href: false // 简介是否加文章链接
            },
            mask:{
                active:true,
                color:"#fff",
                opacity:0.6
            },
            thumb: false,
            href: true, // 图片是否加链接
            zWidth:980,
            zHeight:400,
            interval: 5000,
            animateTime:500,
            isNavHover: false,
            auto:true,
            start:1,
            slider:true
        },
        o = $.extend(true, {}, defaults, opts),
        zW = o.zWidth,
        zH = o.zHeight,
        r = zW / zH;
        if (o.p !== null && eval('typeof getImgJson') == "function")
            o.json = getImgJson(o.p).concat(o.json);
        var time = Number(new Date());
        return this.each(function() {
            // 读取数据
            var c = $(this),
                pre = c.children(),
                preJSON = [],
                id = 'slide'+time;
                time++;
            $.each(pre, function(i, e) {
                var preData = {};
                preData.title = $(e).attr("data-title") || '';
                preData.url = $(e).attr("data-url") || '';
                preData.text = $(e).attr("data-text") || '';
                preData.src = $(e).attr("data-src") || '';
                preJSON.push(preData);
            });
            o.json = preJSON.concat(o.json);
            if (o.json.length < 1)
                return c.html('<em style="color:#c00">Sudyslide Error: Not Found Data, Need to Bind!</em>');
            
            //初始化HTML元素
            c.html(function(index, html) {
                html = "";
                $.each(o.json, function() {
                    html += '<img src="' + this.src.replace("_s","") + '">';
                });
                return html;
            });
            c.children().wrap('<div class="slide-item" />').end().wrapInner('<div class="slide-container" />');
            var u = $(".slide-container", c),
                l = $(".slide-item", u),
                len = l.length;
            if(o.title.active)
                $('<div class="slide-title-bar"><div class="slide-title-bg"></div><h2 class="slide-title"></h2></div>').appendTo(c);
            if(o.text.active)
                $('<div class="slide-text-box"><div class="slide-text-bg"></div><div class="slide-text-inner"><p class="slide-text"></p></div></div>').appendTo(c);
            if(o.mask){
                $('<div class="slide-mask mask-left" /><div class="slide-mask mask-right" />').appendTo(c);
                u.css("overflow","visible");
            }
            if(o.thumb)
                $('<div class="slide-thumb"/>').html(function(index,html){
                    $.each(o.json, function() {
                        html += '<a href="javascript:;" class="thumb-image"><img src="' + this.src + '"></a>';
                    });
                    return html;
                }).appendTo(c);
            
            if(len >1 )
                $('<a class="slide-navigation slide-prev">&lt;</a><a class="slide-navigation slide-next">&gt;</a>').appendTo(c);
            var $title = $(".slide-title-bar", c),
                $text = $(".slide-text-box", c),
                $nav = $(".slide-navigation", c),
                $mask = $(".slide-mask",c).css({"background-color":o.mask.color,"opacity":o.mask.opacity}),
                $thumb = $(".slide-thumb",c),
                title = $('.slide-title', $title),
                text = $(".slide-text", $text);
                prev = $('.slide-prev', c),
                next = $('.slide-next', c),
                thumb = $(".thumb-image", $thumb);
            if (o.isNavHover) {
                $nav.hide();
                c.hover(function() {
                    $nav.show();
                }, function() {
                    $nav.hide();
                });
            }
            c.css({
                width: zW + 'px',
                height: zH + 'px'
            }).addClass('slide-wrap').wrap('<div class="sudy-slide" id="'+id+'"/>');
            var $S = $('#'+id);
            var step = 100/len;
            var $slider = $('<div class="slider" />').css({
            	width: step+"%",
            	left:step*(o.start-1)+"%"
            });
            	$slider.html('<span />');
            if(o.slider){
            	
            	$('<div class="slide-slider"/>').css({
            		width: zW
            	}).html(function(index,html){
                    $.each(o.json, function(index, val) {
                        html += '<div class="slide-slider-item" style="width:'+step+'%;left:'+(step*index)+'%;"><div class="slider-bar"></div></div>';
                    });
                    return html;
                }).appendTo($S);
                $('.slide-slider', $S).append($slider);
            }
            u.css({
                width: zW + 'px',
                height: zH + 'px'
            });
            // 内容显示函数
            function showIndex(index) {
                $title.add($text).hide();
                var $titleHtml = $.trim(o.json[index].title || ""),
                    $textHtml = $.trim(o.json[index].text || "");
                    $url = $.trim(o.json[index].url || "");
                    if(/无链接/.test($url))
                    	$url = "";
                    if(/无标题/.test($titleHtml))
                    	$titleHtml = "";
                // 是否显示链接
                if ($url !== '' && $url !== '#') {
                    var $href = $('<a href="' + $url + '" target="_blank"></a>');
                    if (o.href && l.eq(index).find("a").length < 1)
                        l.eq(index).wrapInner($href);
                    if (o.title.href && $titleHtml !== "")
                        $titleHtml = $href.clone().html($titleHtml);
                    if (o.text.href && $textHtml !== "")
                        $textHtml = $href.clone().html($textHtml);
                }
                if ($titleHtml !== '') {
                    $title.show();
                    title.html($titleHtml);
                }
                if ($textHtml !== '') {
                    $text.show();
                    text.html($textHtml);
                }
                // 标题背景自动宽度
                if (o.title.isAutoWidth)
                    title.parent().css("width", title.outerWidth());
                // 内容背景自动高度
                if (o.text.isAutoHeight)
                    text.parent().parent().css("height", text.outerHeight());
                // 焦点状态
                thumb.removeClass('thumb-active').eq(index).addClass('thumb-active');
            }

            var i = o.start-1;
            // 初始化状态
            l.eq(i).css('left', 0).end().eq(i + 1).css('left', zW).end().eq(i - 1).css('left', -zW);
            showIndex(i);

            // 效果
            var getNextIndex = function (y) { return i + y >= len ? i + y - len : i + y; },
                getPrevIndex = function (y) { return i - y < 0 ? len + i - y : i - y; },
                silde = function (d) {
                   	l.eq((d ? getPrevIndex(2) : getNextIndex(2))).css({'left': (d ? (-2*zW) : (2*zW)),'zIndex':10});
                    l.animate({
                        'left': (d ? '+=' : '-=') + zW
                    }, o.animateTime);
                    i = d ? getPrevIndex(1) : getNextIndex(1);

                    $slider.stop().animate({left:i*step+"%"}, o.animateTime*0.5);
                    showIndex(i);
                };          
            if(o.auto){
                var s = setInterval(function () { silde(false); }, o.interval);
                c.hover(function () { clearInterval(s); }, function () { s = setInterval(function () { silde(false); }, o.interval); });
            }
            prev.click(function () {
                if ($(':animated').length === 0) {
                    silde(true);
                }
            });
            next.click(function () {
                if ($(':animated').length === 0) {
                    silde(false);
                }
            });
        });
    }
})(jQuery);